
<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "219971a8b25d4506877afc0a72110eb1"}'></script><!-- End Cloudflare Web Analytics -->

{%- comment -%} 
<script>
const GA_MEASUREMENT_ID = "G-Z9JCDZ2BYZ";
const CONSENT_KEY = "ga_consent";
const DENY_SESSION_KEY = "ga_deny_session";

function loadGA() {
  if (window.__gaLoaded) return;
  window.__gaLoaded = true;

  const s = document.createElement("script");
  s.async = true;
  s.src = "https://www.googletagmanager.com/gtag/js?id=" + GA_MEASUREMENT_ID;
  document.head.appendChild(s);

  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  window.gtag = gtag;

  gtag("js", new Date());
  gtag("config", GA_MEASUREMENT_ID);
}

function injectBanner() {
  if (document.getElementById("ga-consent-banner")) return;

  const d = document.createElement("div");
  d.id = "ga-consent-banner";
  d.style.cssText =
    "position:fixed;bottom:0;left:0;width:100%;background:#222;color:#eee;" +
    "padding:12px 16px;font-size:14px;z-index:9999;text-align:center;" + 
    "border-top:1px solid #333;";

  d.innerHTML = `
    <p style="margin:0 0 6px 0;">
      本サイトでは、サイトの利用状況を把握し、コンテンツ改善に役立てる目的で
      Google Analyticsを使用しています。
      Google AnalyticsはCookieを利用して匿名のアクセス情報を収集する場合があります。
      これらの情報には、個人を特定できる情報は含まれません。<br>
    </p>
    <p style="margin:0 0 10px 0;font-size:13px;">
      This site uses Google Analytics to understand how the site is used and to improve its content.
      Google Analytics may use cookies to collect anonymous usage data. 
      No personally identifiable information is collected.
    </p>
    <button id="ga-ok">許可(Accept)</button>
    <button id="ga-no" style="margin-left:8px;">拒否(Decline)</button>
  `;

  document.body.appendChild(d);

  document.getElementById("ga-ok").onclick = () => {
    localStorage.setItem(CONSENT_KEY, "granted");
    d.remove();
    loadGA();
  };

  document.getElementById("ga-no").onclick = () => {
    sessionStorage.setItem(DENY_SESSION_KEY, "1");
    d.remove();
  };
}

document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem(CONSENT_KEY) === "granted") {
    loadGA();
    return;
  }
  if (!sessionStorage.getItem(DENY_SESSION_KEY)) {
    injectBanner();
  }
});
</script>
{%- endcomment -%} 
