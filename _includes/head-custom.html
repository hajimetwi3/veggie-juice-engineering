<script>
const GA_MEASUREMENT_ID = "G-Z9JCDZ2BYZ";
const CONSENT_KEY = "ga_consent";
const DENY_SESSION_KEY = "ga_deny_session";

function loadGA() {
  if (window.__gaLoaded) return;
  window.__gaLoaded = true;

  const s = document.createElement("script");
  s.async = true;
  s.src = "https://www.googletagmanager.com/gtag/js?id=" + GA_MEASUREMENT_ID;
  document.head.appendChild(s);

  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  window.gtag = gtag;

  gtag("js", new Date());
  gtag("config", GA_MEASUREMENT_ID);
}

function injectBanner() {
  if (document.getElementById("ga-consent-banner")) return;

  const d = document.createElement("div");
  d.id = "ga-consent-banner";
  d.style.cssText =
    "position:fixed;bottom:0;left:0;width:100%;background:#111;color:#eee;" +
    "padding:12px 16px;font-size:14px;z-index:9999;text-align:center;";

  d.innerHTML = `
    <p style="margin:0 0 6px 0;">
      本サイトはアクセス解析のために Google Analytics を利用しています。<br>
      Google により Cookie を用いたデータ収集・処理が行われる場合があります。
    </p>
    <p style="margin:0 0 10px 0;font-size:13px;">
      This site uses Google Analytics to understand traffic and improve content.
      Google may use cookies and collect usage data for analytics purposes.
    </p>
    <button id="ga-ok">OK</button>
    <button id="ga-no" style="margin-left:8px;">NO</button>
  `;

  document.body.appendChild(d);

  document.getElementById("ga-ok").onclick = () => {
    localStorage.setItem(CONSENT_KEY, "granted");
    d.remove();
    loadGA();
  };

  document.getElementById("ga-no").onclick = () => {
    sessionStorage.setItem(DENY_SESSION_KEY, "1");
    d.remove();
  };
}

document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem(CONSENT_KEY) === "granted") {
    loadGA();
    return;
  }
  if (!sessionStorage.getItem(DENY_SESSION_KEY)) {
    injectBanner();
  }
});
</script>
